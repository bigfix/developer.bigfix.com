#!/bin/bash

set -e
set -x

# Add node yum repo
curl -sL https://rpm.nodesource.com/setup | bash -

# Add epel for nginx
yum install -y epel-release

# Install all the things
yum install -y nginx nodejs rsync

# Setup Makefile that points to the Makefile in the source directory
echo 'SOURCE=/vagrant' >> /home/vagrant/Makefile
echo 'include /vagrant/Makefile' >> /home/vagrant/Makefile

# Start nginx now and forever
systemctl enable nginx.service
systemctl start nginx.service

# Setup nginx
make nginx-dev

# Build the site
sudo -H -u vagrant make staging remote-staging
make deploy remote-deploy
